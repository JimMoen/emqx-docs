# MQTT 会话和消息持久化

从 v5.5.x 版本开始，EMQX 内置了 MQTT 会话和消息的持久存储。本页面介绍了 EMQX 的会话持久化功能及其如何确保 EMQX 节点重启后恢复客户端会话，这对于需要高可靠性的 IoT 应用是一个重大的增强。

::: warning 重要通知

该功能目前处于公开 alpha 阶段。在进一步通知之前，我们建议不要在包含关键数据的生产环境中启用此功能。

在 alpha 阶段，MQTT 消息和会话的磁盘存储格式可能会更改。因此，EMQX 的一个版本记录的数据可能在升级到后续版本后无法读取。该注意事项在最终版本发布时将不再适用。

:::

## 了解 EMQX 中的客户端会话

在 EMQX 中，客户端会话有助于管理 MQTT broker 中的客户端连接和状态。从版本 5.5 开始，EMQX 提供了两种不同的客户端会话管理应用：常规客户端会话和持久客户端会话。

::: tip

有关会话的更多信息，请参阅 [MQTT 持久会话与 Clean Session 详解](https://www.emqx.com/zh/blog/mqtt-session)。

:::

### 常规客户端会话

常规客户端会话是临时的，仅在客户端连接到 EMQX 的持续时间内存在。当具有常规会话的客户端断开连接时，所有会话信息，包括订阅和未传送的消息，都将被丢弃。

### 持久客户端会话

持久客户端会话旨在即使客户端断开连接后也保留会话信息。这包括标记为传送但尚未发送给客户端或客户端未确认的订阅和消息。当客户端使用相同的会话 ID 重新连接时，它可以恢复其会话状态，接收其断开期间保留的任何消息。

EMQX 根据客户端的协议版本和会话设置确定客户端会话是否为持久会话：

- 对于使用 MQTT 5 协议的客户端，`CONNECT` 或 `DISCONNECT` 包的[会话过期间隔](https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901048)属性设置为大于 0 的值。
- 对于使用 MQTT 3.* 协议的客户端，[清除会话](http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718030)标志设置为 0，并且 `mqtt.session_expiry_interval` 配置参数设置为大于 0 的值。

会话持久化功能仅影响持久客户端会话。不满足上述标准的客户端会话不受此功能影响，将像往常一样处理。

## 启用会话持久化

EMQX 中的会话持久化功能默认是禁用的。可以通过将 `durable_sessions.enable` 配置参数设置为 `true` 来启用。

## 会话持久化功能介绍

EMQX 采用了独特的方法来管理持久会话的消息持久性。当具有持久会话的客户端订阅一个主题过滤器时，EMQX 将匹配该过滤器的主题标记为 "durable"。这确保了除了将 MQTT PUBLISH 消息从这些主题路由到活动会话外，代理还会将这些消息保存在磁盘上。EMQX 与一个内置的 RocksDB 数据库直接集成作为存储后端。

每个持久的 MQTT 消息在磁盘上只存储一次，无论有多少个持久会话订阅了匹配的主题过滤器，以及这些会话当前是否已连接。这使得消息能够高效地分发到持久会话。

### 持久存储架构

EMQX 的持久存储架构是一个层次结构，包括碎片（shards）、生成（generations）和流（streams）。

#### 碎片

这一层级通过客户端将消息分隔开来，根据发布者的客户端 ID 在不同的碎片中存储消息。碎片的数量由 `durable_sessions.storage.builtin.n_shards` 配置参数在 EMQX 首次启动时确定。

#### 生成

在每个碎片内部，数据进一步划分为覆盖特定时间段的生成。新消息只写入当前的生成，而以前的生成只能用于读取。EMQX 通过删除旧的生成来清理旧消息。消息保留多长时间由 `durable_sessions.message_retention_period` 参数指定。

不同的生成可以根据*存储布局*规范以不同的方式组织数据。目前只支持一种布局，旨在优化覆盖大量主题的通配符订阅的吞吐量以及单主题订阅的吞吐量。

未来的更新将引入更多的布局，以优化不同类型的工作负载，例如在某些应用中优先考虑低延迟而不是高吞吐量。

#### 流

每个碎片和生成中的消息被划分为流。流作为 EMQX 中消息序列化的单元。流可以包含来自多个主题的消息。不同的存储布局可以采用不同的策略将主题映射到流中。

持久会话通过从流中批量获取消息与这个结构交互，批量大小可以通过 `durable_sessions.max_batch_size` 参数调整。这个全面的系统确保 EMQX 能够高效地处理持久消息的存储和检索。

### 集群中的会话持久化

EMQX 集群中的每个节点都被分配了一个唯一的 site ID，作为稳定的标识符，独立于 Erlang 节点名称（`emqx@...`）。Site ID 是持久的，并且在节点首次启动时随机生成。这种稳定性维护了持久会话和消息的完整性，特别是在节点可能经历名称修改或重新配置的场景中。

通过将持久会话和消息与唯一的 Site ID 而不仅仅是节点的名称关联，EMQX 确保这些会话可以可靠地管理和恢复，即使底层节点的详细信息发生变化。

为了管理和监控集群中的持久会话，管理员可以使用 `emqx_ctl ds info` CLI 命令来检查不同站点的状态。

## 会话持久化的硬件要求

启用会话持久化时，EMQX 会将持久会话的元数据和发送到持久会话的 MQTT 消息保存在磁盘上。因此，必须在具有足够大存储容量的服务器上部署 EMQX。为了实现最佳吞吐量，建议使用固态硬盘（SSD）存储。

存储需求可以根据以下准则估算：

- **消息存储**：存储消息所需的空间与进入消息的速率乘以 `durable_sessions.message_retention_period` 参数指定的持续时间成正比。此参数指定消息保留的时间长短，影响所需的总存储量。
- **会话元数据存储**：会话元数据的存储量与会话数量乘以订阅的流数量成正比。
- **流计算**：流的数量与碎片的数量成正比。
